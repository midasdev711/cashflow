{% extends "../detail.html" %}
{% load humanize %}

{% block title %}
    {{ invoice.description|capfirst }}
{% endblock %}

{% block action %}
{% comment "later" %}
    {% if user.username == invoice.owner.user.username %}
        <a href="{% url 'invoices-edit' invoice.id %}" class="primary-action">
            Redigera faktura
        </a>
    {% endif %}
{% endcomment %}
{% endblock %}

{% block full_content %}
<div id="app">
    {% if invoice.is_payable and user.profile.may_pay %}
    <form method="POST" action="{% url 'admin-invoice-pay' invoice.id %}" class="form-horizontal" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="submit" value="Markera som betald" class="button primary-action theme-color btn-color" style="margin: 0 auto; display: block;" />
    </form>
    {% endif %}
    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <h2>Fakturadelar</h2>
    <table>
        <thead>
            <tr>
                <th>
                    Belopp
                </th>
                <th>
                    Nämnd
                </th>
                <th>
                    Sekundärt resultatställe
                </th>
                <th>
                    Budgetpost
                </th>
                <th>
                    Attesterad av
                </th>
            </tr>
        </thead>
        <tbody>
        {% for invoice_part in invoice.invoicepart_set.all %}
            <tr>
                <td>
                    <span class="value">{{ invoice_part.amount|intcomma }} kr</span>
                </td>
                <td>
                    <a class="value" href="https://budget.datasektionen.se/committees/{{ invoice_part.committee_id }}">
                        {{ invoice_part.committee_name }}
                    </a>
                </td>
                <td>
                    <span class="value">{{ invoice_part.cost_centre_name }}</span>
                </td>
                <td>
                    <span class="value">{{ invoice_part.budget_line_name }}</span>
                </td>
                <td>
                    {% if invoice_part.attested_by %}
                    <a class="value" href="{% url 'user-show' invoice_part.attested_by.user.username %}">
                        {{ invoice_part.attested_by.user.get_full_name }} ({{ invoice_part.attest_date }})
                    </a>
                    {% else %}
                        {% if invoice.owner.user.username != user.username and invoice_part.committee_name|lower in user.profile.may_attest %}
                            <span style="display: block;">
                                <form method="POST" action="{% url 'admin-invoicepart-attest' invoice_part.id %}">
                                    {% csrf_token %}
                                    <button class="pull-right small theme-color btn-color" type="submit" style="margin-right:15px;"><i class="fa fa-check" aria-hidden="true"></i></button>
                                    <span style="margin: 5px 0;display:inline-block;">Du kan attestera &nbsp;</span>
                                </form>
                            </span>
                        {% else %}
                            <span class="value">Ej attesterad</span>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <div class="clear" style="height:50px;"></div>


    <div class="col-sm-6 col-lg-6" style="padding-left: 0;">
        <h2>Information</h2>
        <table>
            <tr>
                <th>Faktura-id:</th>
                <td>{{ invoice.id }}</td>
            </tr>
            <tr>
                <th>Skapad av:</th>
                <td>
                    <a href="{% url 'user-show' invoice.owner.user.username %}">
                        {{ invoice.owner.user.get_full_name }} ({{ invoice.owner.user.username }}@kth.se)
                    </a>
                </td>
            </tr>
            <tr>
                <th>Fakturadatum:</th>
                <td>
                    {{ invoice.invoice_date|date:"Y-m-d" }}
                </td>
            </tr>
            <tr>
                <th>Förfallodatum:</th>
                <td>
                    {{ invoice.due_date|date:"Y-m-d" }}
                </td>
            </tr>
            <tr>
                <th>Totalsumma:</th>
                <td>
                    {{ invoice.total_amount|intcomma }} kr
                </td>
            </tr>
            <tr>
                <th>Registrerat i Cashflow:</th>
                <td>
                    {{ invoice.created_date|date:"Y-m-d" }}
                </td>
            </tr>
            <tr>
                <th>Bekräftat i pärmen:</th>
                <td>
                    {% if invoice.confirmed_by_id %}
                     {{ invoice.confirmed_by.get_full_name }} ({{ invoice.confirmed_at }})
                    {% else %}
                    Inte än
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Betalad:</th>
                <td>
                    {% if invoice.payed_at %}
                        {{ invoice.payed_at|date:"c" }} av {{ invoice.payed_by.profile }}
                    {% else %}
                        Ej betalad
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Verifikationsnummer:</th>
                <td>{{ invoice.verification|default:"Ej bokförd" }} {% comment "if may_account" %}(<a href="{% url 'admin-invoice-edit-verification' invoice.id %}">Ändra</a>){% endcomment %}</td>
            </tr>
        </table>
    </div>

    <div class="col-sm-6 col-lg-6" style="padding-right: 0;">
        <h2>Filer</h2>
        {% for file in invoice.file_set.all %}
        <a href="{{ file.file.url }}">{{ file.file.name }}</a>:<br>
        {% if  file.is_image %}
        <a href="{{ file.file.url }}" target="_blank">
            <img class="zoom center-block" style="width: 70%;" src="{{ file.file.url }}" />
        </a>
        {% else %}
        <iframe src="{{ file.file.url }}" style="width:100%;height: 60vh;"></iframe>
        {% endif %}
        <br>
        {% endfor %}
    </div>


    <div class="clearfix"></div>
    <div>
        <h2>Kommentarer</h2>

        <ul class="comments">
            {% for comment in invoice.comment_set.all %}
            <li class="clearfix {% if comment.author.user.username == user.username %}own{% endif %}">
                <div class="info">
                    <a v-tooltip="{ content: '{{ comment.author.user.get_full_name }}' }" class="crop" style="background-image:url(https://zfinger.datasektionen.se/user/{{ comment.author.user.username }}/image);" href="/user/{{ comment.author.user.username }}"></a>
                    <span class="name">
                        <a href="{% url 'user-show' comment.author.user.username %}">
                            
                        </a>
                    </span>
                </div>
                <div class="comment" v-tooltip="{ content: 'Skapad {{ comment.date|date:'Y-m-d H:i' }}' }">
                    {{ comment.content }}
                </div>
            </li>
            {% endfor %}
            <li class="new">
                <div class="comment">
                    <form method="POST" id="new" action="{% url 'invoices-comment' invoice.id %}">
                        {% csrf_token %}
                        <textarea id="content-field" name="content" rows="3" style="width: 100%;border:none;" placeholder="Skriv en kommentar"></textarea>
                        <button class="pull-right button theme-color btn-color" type="submit">Kommentera</button>
                        <div class="clearfix"></div>
                    </form>
                </div>
            </li>
            <li class="alternatives">
                <h3>Eller skicka en färdig kommentar:</h3>
                <ul>
                    <li><a href="#" v-on:click="send">Jag kan inte hitta ditt utlägg i pärmen. Har du satt in det?</a></li>
                    <li><a href="#" v-on:click="send">Jag attesterar också detta.</a></li>
                    <li><a href="#" v-on:click="send">Det här har jag inte godkänt.</a></li>
                    <li><a href="#" v-on:click="send">Du har angivit större belopp än vad som står på fakturan.</a></li>
                    <li><a href="#" v-on:click="send">Du måste ladda upp både en faktura och ett kontoutdrag.</a></li>
                    <li><a href="#" v-on:click="send">Avvakta med det här utlägget.</a></li>
                </ul>
            </li>
        </ul>
    </div>
    <div class="clearfix"></div>
</div>

<script type="text/javascript">
    new Vue({
        el: '#app', 
        data: function () {
            return {

            }
        },
        methods: {
            send(e) {
                e.preventDefault()
                console.log(e.target.innerHTML)
                document.getElementById('content-field').value = e.target.innerHTML
                document.getElementById('new').submit()
            }
        },
        created() {

        }
    })
</script>
{% endblock %}
